<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICU Smart-Alert System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --color-bg: #1a1a1a;
            --color-card: #2c2c2c;
            --color-text: #f0f0f0;
            --color-border: #444;
            --color-primary: #007bff;
            --color-secondary: #17a2b8; /* For 'Mark as Read' */
            --color-warn: #ffc107;
            --color-danger: #dc3545;
            --color-shadow: #0000004d;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 24px;
        }
        header {
            text-align: center;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 20px;
            margin-bottom: 24px;
        }
        h1 { color: var(--color-primary); margin: 0; }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-card);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--color-shadow);
            margin-bottom: 24px;
        }
        .button-group { display: flex; gap: 10px; }
        .sim-button {
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        #startButton { background-color: var(--color-primary); }
        #startButton:hover { background-color: #0056b3; }
        #startButton:disabled { background-color: #555; cursor: not-allowed; }
        
        #stopButton { background-color: var(--color-danger); }
        #stopButton:hover { background-color: #a71d2a; }
        #stopButton:disabled { background-color: #555; cursor: not-allowed; }

        #snoozeButton {
            background-color: var(--color-warn);
            color: #1a1a1a;
            font-weight: 700;
            display: none; /* Hidden by default */
            animation: pulse 1.5s infinite;
        }
        #snoozeButton:hover { background-color: #ffda6a; }

        #status-text { font-size: 1.1em; font-weight: 500; }
        #clock {
            font-family: "Courier New", Courier, monospace;
            font-size: 1.2em;
            color: var(--color-warn);
            font-weight: 700;
        }

        .main-layout { display: flex; flex-direction: column; gap: 24px; }
        .charts-container { display: flex; flex-direction: column; gap: 20px; }
        .chart-wrapper {
            background-color: var(--color-card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--color-shadow);
            height: 350px; 
        }
        
        #alerts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px; 
        }
        .alert-card {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-left: 6px solid var(--color-warn);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px var(--color-shadow);
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        .alert-card.EARLY_SHOCK_P-A,
        .alert-card.RESP_DISTRESS_P-B {
            border-left-color: var(--color-danger);
        }
        .alert-card h2 {
            margin-top: 0;
            color: var(--color-warn);
            font-size: 1.2em;
        }
        .alert-card.EARLY_SHOCK_P-A h2,
        .alert-card.RESP_DISTRESS_P-B h2 {
            color: var(--color-danger);
        }

        /* --- NEW: Styles for LLM Response and "Mark as Read" --- */
        .llm-response pre {
            background-color: var(--color-bg);
            padding: 12px;
            border-radius: 6px;
            font-family: "Courier New", Courier, monospace;
            font-size: 1em; /* Make it readable */
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--color-text);
        }
        .mark-read-button {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
        }
        .mark-read-button:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
        }

        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>

    <header>
        <h1>ü©∫ ICU Smart-Alert System (v2.0 with GenAI)</h1>
        <p>Live Patient Monitoring Simulation</p>
    </header>

    <div class="status-bar">
        <div class="button-group">
            <button id="startButton" class="sim-button">Start Simulation</button>
            <button id="stopButton" class="sim-button" disabled>Stop Simulation</button>
            <button id="snoozeButton" class="sim-button">SNOOZE ‚è∞</button>
        </div>
        <div id="status-text">Status: Idle.</div>
        <div id="clock">Time: 00:00:00</div>
    </div>

    <div class="main-layout">
        <div class="charts-container">
            <div class="chart-wrapper"><canvas id="chartHR_MAP"></canvas></div>
            <div class="chart-wrapper"><canvas id="chartRR_SPO2"></canvas></div>
        </div>
        <div id="alerts-container">
            </div>
    </div>

    <script>
        // --- 1. CONNECT TO THE BACKEND ---
        const socket = io();
        
        // --- 2. GET REFERENCES TO HTML ELEMENTS ---
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const snoozeButton = document.getElementById('snoozeButton'); 
        const statusText = document.getElementById('status-text');
        const clock = document.getElementById('clock');
        const alertsContainer = document.getElementById('alerts-container');
        
        // --- NEW: Global state for snooze dependency ---
        let isAlertAcknowledged = true; // Start as true (no alert active)

        // --- 3. CHART.JS SETUP ---
        let charts = {};
        const MAX_CHART_POINTS = 30; 
        const ALERT_COLOR = 'rgba(220, 53, 69, 1)';
        const HR_COLOR = 'rgba(0, 123, 255, 1)';
        const MAP_COLOR = 'rgba(255, 193, 7, 1)';
        const RR_COLOR = 'rgba(23, 162, 184, 1)';
        const SPO2_COLOR = 'rgba(40, 167, 69, 1)';

        function createChart(canvasId, title, yAxes) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const datasets = yAxes.map(axis => ({
                label: axis.label, data: [],
                borderColor: axis.color, backgroundColor: axis.color,
                pointBackgroundColor: [],
                tension: 0.1, borderWidth: 2, pointRadius: 3
            }));
            return new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        title: { display: true, text: title, color: 'white', font: { size: 16 } }
                    },
                    animation: { duration: 0 }
                }
            });
        }

        function initCharts() {
            if (charts.hrMap) charts.hrMap.destroy();
            if (charts.rrSpo2) charts.rrSpo2.destroy();
            charts.hrMap = createChart('chartHR_MAP', 'Heart Rate (HR) & Mean Arterial Pressure (MAP)', [
                { label: 'HR (bpm)', color: HR_COLOR },
                { label: 'MAP (mmHg)', color: MAP_COLOR }
            ]);
            charts.rrSpo2 = createChart('chartRR_SPO2', 'Respiratory Rate (RR) & Oxygen Saturation (SpO2)', [
                { label: 'RR (breaths/min)', color: RR_COLOR },
                { label: 'SpO2 (%)', color: SPO2_COLOR }
            ]);
        }

        function addDataToCharts(data) {
            const time = data.time;
            charts.hrMap.data.labels.push(time);
            charts.hrMap.data.datasets[0].data.push(data.hr);
            charts.hrMap.data.datasets[1].data.push(data.map);
            charts.hrMap.data.datasets[0].pointBackgroundColor.push(HR_COLOR);
            charts.hrMap.data.datasets[1].pointBackgroundColor.push(MAP_COLOR);
            charts.rrSpo2.data.labels.push(time);
            charts.rrSpo2.data.datasets[0].data.push(data.rr);
            charts.rrSpo2.data.datasets[1].data.push(data.spo2);
            charts.rrSpo2.data.datasets[0].pointBackgroundColor.push(RR_COLOR);
            charts.rrSpo2.data.datasets[1].pointBackgroundColor.push(SPO2_COLOR);

            function prune(chart) {
                if (chart.data.labels.length > MAX_CHART_POINTS) {
                    chart.data.labels.shift();
                    chart.data.datasets.forEach(dataset => {
                        dataset.data.shift();
                        dataset.pointBackgroundColor.shift();
                    });
                }
            }
            prune(charts.hrMap);
            prune(charts.rrSpo2);
            charts.hrMap.update();
            charts.rrSpo2.update();
        }

        // --- 4. EVENT LISTENERS FOR BUTTONS ---
        startButton.addEventListener('click', () => {
            console.log("Starting simulation...");
            startButton.disabled = true;
            stopButton.disabled = false;
            snoozeButton.style.display = 'none';
            isAlertAcknowledged = true; // Reset
            statusText.textContent = "Status: Connecting...";
            alertsContainer.innerHTML = '';
            initCharts();
            socket.emit('start_simulation');
        });

        stopButton.addEventListener('click', () => {
            console.log("Stopping simulation...");
            startButton.disabled = false;
            stopButton.disabled = true;
            snoozeButton.style.display = 'none';
            isAlertAcknowledged = true; // Reset
            socket.emit('stop_simulation');
        });
        
        snoozeButton.addEventListener('click', () => {
            // --- NEW: Check if alert is acknowledged ---
            if (!isAlertAcknowledged) {
                alert("You must 'Mark as Read' on the active alert before snoozing!");
                return;
            }
            
            console.log("Snooze button clicked.");
            snoozeButton.style.display = 'none';
            socket.emit('snooze_clicked');
        });
        
        // --- NEW: Event Delegation for 'Mark as Read' ---
        alertsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('mark-read-button')) {
                console.log("Mark as Read clicked.");
                
                // 1. Set the global flag
                isAlertAcknowledged = true;
                
                // 2. Update the button
                const button = event.target;
                button.disabled = true;
                button.textContent = 'Acknowledged ‚úì';
                
                // 3. Optional: Change the card style to show it's read
                button.closest('.alert-card').style.borderLeftColor = 'var(--color-secondary)';
            }
        });

        // --- 5. SOCKET.IO EVENT HANDLERS ---
        socket.on('connect', () => {
            console.log('Connected to server.');
            statusText.textContent = "Status: Connected. Ready to start.";
        });

        socket.on('status_update', (data) => {
            statusText.textContent = `Status: ${data.msg}`;
        });

        socket.on('simulation_tick', (data) => {
            clock.textContent = `Time: ${data.time}`;
            addDataToCharts(data);
        });

        socket.on('simulation_ended', () => {
            console.log('Simulation finished or stopped.');
            startButton.disabled = false;
            stopButton.disabled = true;
            snoozeButton.style.display = 'none';
            isAlertAcknowledged = true; // Reset
            startButton.textContent = "Restart Simulation";
        });
        
        socket.on('activate_alarm', () => {
            snoozeButton.style.display = 'block';
            isAlertAcknowledged = false; // A new, unread alert is active
        });
        
        socket.on('deactivate_alarm', () => {
            snoozeButton.style.display = 'none';
            isAlertAcknowledged = true; // Alarm is no longer active
        });

        // --- MODIFIED: Listen for 'new_llm_alert' ---
        socket.on('new_llm_alert', (payload) => {
            console.log('New LLM Alert Received:', payload);
            
            const alertData = payload.alert_data;
            const llmAnalysis = payload.llm_analysis;

            // Mark the point on the graph
            function markAlert(chart) {
                chart.data.datasets.forEach(dataset => {
                    const lastIndex = dataset.pointBackgroundColor.length - 1;
                    if(lastIndex >= 0) {
                        dataset.pointBackgroundColor[lastIndex] = ALERT_COLOR;
                    }
                });
                chart.update();
            }
            markAlert(charts.hrMap);
            markAlert(charts.rrSpo2);

            // Create the new alert card
            const alertCard = document.createElement('div');
            alertCard.className = `alert-card ${alertData.pattern_detected}`;
            
            // Format the LLM response
            const formattedAnalysis = llmAnalysis.replace(/\n/g, '<br>');

            alertCard.innerHTML = `
                <h2>
                    üö® LLM ASSESSMENT (Risk: ${(alertData.risk_score_proba * 100).toFixed(1)}%)
                </h2>
                
                <div class="llm-response">
                    <pre>${llmAnalysis}</pre> </div>

                <p style="font-size: 0.9em; color: #aaa; margin-top: 15px;">
                    <strong>Patient:</strong> ${alertData.patient_id} | 
                    <strong>Time:</strong> ${alertData.window_end_time}
                </p>
                
                <button class="mark-read-button">Mark as Read</button>
            `;
            alertsContainer.prepend(alertCard);
        });

        // --- Initial Page Load ---
        initCharts();
        stopButton.disabled = true;

    </script>
</body>
</html>